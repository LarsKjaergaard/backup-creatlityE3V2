#=======================================================================
# Includes 
#-----------------------------------------------------------------------
[include fluidd.cfg]
[include macros_klipperscreen.cfg]

#=======================================================================
# Controllers
#-----------------------------------------------------------------------
[mcu]
canbus_uuid: 345528508a29

[mcu HermitCrab]
serial: /dev/serial/by-id/usb-Klipper_stm32f072xb_1A0042000E57434135353820-if00

[virtual_sdcard]
path: /home/biqu/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[temperature_sensor MCUTemp]
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 0
max_temp: 100

[temperature_sensor HermitCrabTemp]
sensor_type: temperature_mcu
sensor_mcu: HermitCrab
min_temp: 0
max_temp: 100

#=======================================================================
# Main
#-----------------------------------------------------------------------
[printer]
kinematics: corexy
max_velocity: 200
max_accel: 2000
max_z_velocity: 5
max_z_accel: 100

#=======================================================================
# Extruder
#-----------------------------------------------------------------------

[adxl345]
cs_pin: HermitCrab: PB12
spi_bus: spi2
axes_map: y,z,-x

#[filament_switch_sensor switch_sensor]
#switch_pin: ^PC5
#pause_on_runout: False
#runout_gcode:
#insert_gcode:

[heater_bed]
heater_pin: PB2 #HB
sensor_type: EPCOS 100K B57560G104F #Generic 3950
sensor_pin: PA3 #TB
#control: pid
# tuned for stock hardware with 50 degree Celsius target
#pid_Kp: 54.027
#pid_Ki: 0.770
#pid_Kd: 948.182
min_temp: 0
max_temp: 130

#=======================================================================
# Motion
#-----------------------------------------------------------------------

[stepper_x]
step_pin: PA14
dir_pin: !PA10
enable_pin: !PA13
microsteps: 16
rotation_distance: 40
position_endstop: 0
position_min: 0
position_max: 235
homing_speed: 25
homing_retract_dist: 0
endstop_pin: tmc2209_stepper_x:virtual_endstop  # correct syntax, required

[tmc2209 stepper_x]
uart_pin: PB8
run_current: 1.0          # LDO 42STH48-1684MAC RMS ~1.68A
hold_current: 0.5
stealthchop_threshold: 0    # required for sensorless homing
diag_pin: ^PC4
driver_SGTHRS: 50         # start here, tune if needed

[stepper_y]
step_pin: PC8
dir_pin: !PA15
enable_pin: !PC14
microsteps: 16
rotation_distance: 40
position_endstop: 0
position_min: 0
position_max: 235
homing_speed: 25
homing_retract_dist: 0
endstop_pin: tmc2209_stepper_y:virtual_endstop  # correct syntax, required

[tmc2209 stepper_y]
uart_pin: PC9
run_current: 1.0
hold_current: 0.5
stealthchop_threshold: 0    # required for sensorless homing
diag_pin: ^PB0
driver_SGTHRS: 60          # start here, tune if needed


[stepper_z]
step_pin: PD2
dir_pin: PD4
enable_pin: !PD3
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop 
position_min: 0
position_max: 200

[tmc2209 stepper_z]
uart_pin: PD0
#diag_pin: PC6
run_current: 0.650
stealthchop_threshold: 999999

[extruder]
step_pin: HermitCrab: PA6
dir_pin: !HermitCrab: PA7
enable_pin: !HermitCrab: PA5
microsteps: 16
rotation_distance: 3.483
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: HermitCrab: PA2
sensor_type: ATC Semitec 104NT-4-R025H42G
min_temp: 0
max_temp: 300
sensor_pin: HermitCrab: PA1
max_extrude_only_distance: 150.0
control: pid
pid_Kp: 21.527
pid_Ki: 1.063
pid_Kd: 108.982
min_temp: 0
max_temp: 250

[tmc2209 extruder]
uart_pin: HermitCrab: PB0
run_current: 0.650
hold_current: 0.500
stealthchop_threshold: 999999

#=======================================================================
# Fans
#-----------------------------------------------------------------------

[fan]
pin: HermitCrab: PA4

[heater_fan hotend_fan]
pin: HermitCrab: PA3
heater: extruder
heater_temp: 50.0

[fan_generic mcu_fan]
pin: PA8

[neopixel hotend_rgb]
pin: HermitCrab:PA8
chain_count: 2
color_order: GRB
initial_RED: 0.5
initial_GREEN: 0.5
initial_BLUE: 0.5

[bltouch]
sensor_pin: ^HermitCrab:PB2
control_pin: HermitCrab:PB1
#z_offset: 3.35
#   The distance (in mm) between the bed and the nozzle when the probe
#   triggers. This parameter must be provided.
x_offset: 38.0
#   The distance (in mm) between the probe and the nozzle along the
#   x-axis. The default is 0.
y_offset: -36.0
#   The distance (in mm) between the probe and the nozzle along the
#   y-axis. The default is 0.

#[safe_z_home]
#home_xy_position: 50, 50
##   A X, Y coordinate (e.g. 100, 100) where the Z homing should be
##   performed. This parameter must be provided.
#speed: 50.0
##   Speed at which the toolhead is moved to the safe Z home
##   coordinate. The default is 50 mm/s
#z_hop: 10
##   Distance (in mm) to lift the Z axis prior to homing. This is
##   applied to any homing command, even if it doesn't home the Z axis.
##   If the Z axis is already homed and the current Z position is less
##   than z_hop, then this will lift the head to a height of z_hop. If
##   the Z axis is not already homed the head is lifted by z_hop.
##   The default is to not implement Z hop.
#z_hop_speed: 15.0
##   Speed (in mm/s) at which the Z axis is lifted prior to homing. The
##   default is 15 mm/s.
#move_to_previous: False
##   When set to True, the X and Y axes are reset to their previous
##   positions after Z axis homing. The default is False.


[bed_screws]
screw1: 25,27
#   The X, Y coordinate of the first bed leveling screw. This is a
#   position to command the nozzle to that is directly above the bed
#   screw (or as close as possible while still being above the bed).
#   This parameter must be provided.
screw1_name: xmin_ymin
#   An arbitrary name for the given screw. This name is displayed when
#   the helper script runs. The default is to use a name based upon
#   the screw XY location.
#screw1_fine_adjust:
#   An X, Y coordinate to command the nozzle to so that one can fine
#   tune the bed leveling screw. The default is to not perform fine
#   adjustments on the bed screw.
screw2: 193,27
screw2_name: xmax_ymin

screw3: 193,195
screw3_name: xmax_ymax

screw4: 25,195
screw4_name: xmin_ymax

#horizontal_move_z: 5
#   The height (in mm) that the head should be commanded to move to
#   when moving from one screw location to the next. The default is 5.
#probe_height: 0
#   The height of the probe (in mm) after adjusting for the thermal
#   expansion of bed and nozzle. The default is zero.
#speed: 50
#   The speed (in mm/s) of non-probing moves during the calibration.
#   The default is 50.
#probe_speed: 5
#   The speed (in mm/s) when moving from a horizontal_move_z position
#   to a probe_height position. The default is 5.

[screws_tilt_adjust]
screw1: -15,62
#   The (X, Y) coordinate of the first bed leveling screw. This is a
#   position to command the nozzle to so that the probe is directly
#   above the bed screw (or as close as possible while still being
#   above the bed). This is the base screw used in calculations. This
#   parameter must be provided.
screw1_name: xmin_ymin
#   An arbitrary name for the given screw. This name is displayed when
#   the helper script runs. The default is to use a name based upon
#   the screw XY location.

screw2: 155,62
screw2_name: xmax_ymin

screw3: 155,231
screw3_name: xmax_ymax

screw4: -15,231
screw4_name: xmin_ymax
#speed: 50
#   The speed (in mm/s) of non-probing moves during the calibration.
#   The default is 50.
#horizontal_move_z: 5
#   The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.
#screw_thread: CW-M3
#   The type of screw used for bed leveling, M3, M4, or M5, and the
#   rotation direction of the knob that is used to level the bed.
#   Accepted values: CW-M3, CCW-M3, CW-M4, CCW-M4, CW-M5, CCW-M5.
#   Default value is CW-M3 which most printers use. A clockwise
#   rotation of the knob decreases the gap between the nozzle and the
#   bed. Conversely, a counter-clockwise rotation increases the gap.

[bed_mesh]
speed: 120
horizontal_move_z: 8
mesh_min: 5, 0
mesh_max: 212, 179
probe_count: 4, 4

[force_move]
enable_force_move: true ; enable FORCE_MOVE and SET_KINEMATIC_POSITION

[homing_override]
gcode:
  SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.0
  SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.0
  G28 X Y
  SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.0
  SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bltouch]
#*# z_offset = 3.490
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 65.921
#*# pid_ki = 1.234
#*# pid_kd = 880.049
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.225000, -0.110000, 0.022500, 0.077500
#*# 	  -0.185000, -0.142500, -0.035000, -0.042500
#*# 	  -0.130000, -0.105000, -0.040000, -0.077500
#*# 	  -0.177500, -0.117500, -0.047500, -0.020000
#*# x_count = 4
#*# y_count = 4
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 5.0
#*# max_x = 212.0
#*# min_y = 0.0
#*# max_y = 178.98
